---
title: "EDA"
author: "Hope Hennessy"
date: "2025-09-17"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(corrplot)
library(lubridate)
library(gridExtra)
```


* Alt (Altitude): Elevation of observation point above sea level (meters). 
* Aspect: Compass direction the slope faces. Range: 0-360° (0=North, 90=East, 180=South, 270=West). Note: North-facing slopes stay colder, south-facing get more sun
* Incline: Steepness/gradient of slope (degrees). Plausible Range: 0-60° (most avalanches occur 30-45°). Purpose: Critical for avalanche formation (too flat=no slide, too steep=continuous sluffing)
* Air.Temp (Air Temperature): Temperature at observation point(degrees celsius)
* Wind.Dir (Wind Direction): Direction wind is blowing FROM (degrees, 0-360). Purpose: Determines snow deposition patterns (lee slopes get loaded)
* Wind.Speed (m/s). Wind transports snow, creates dangerous loading
* Cloud (Cloud Cover): Sky coverage by clouds. Range: 0-100%
* Precip.Code (Precipitation Code): Type and intensity of precipitation. Categorical
* Drift (Snow Drift): Active snow transport by wind. Binary (0 = No, 1 = Yes)
* Rain.at.900: Rainfall at 900m elevation. Binary (0 = No, 1 = Yes). Purpose: Rain on snow = very dangerous 
* Summit.Air.Temp (degrees Celsius)
* Summit.Wind.Dir
* Summit.Wind.Speed (m/s)
* Total.Snow.Depth: Total height of snowpack (cm)
* Foot.Pen (Foot Penetration): How deep foot sinks into snow when walking (cm). Indicates snow consolidation/stability. Soft snow (high penetration) = unstable
* Ski.Pen (Ski Penetration): How deep skis sink into snow (cm)
* Max.Temp.Grad (Maximum Temperature Gradient): Largest temperature difference within snowpack. Large gradients can cause weak layers in the snow and increase avalanche risk.
* Max.Hardness.Grad (Maximum Hardness Gradient): Largest difference in snow hardness between layers. A gradient measures the change in hardness between layers, which indicates weak spots that could lead to avalanche failure.
* No.Settle (New Snow Settlement): Amount of settlement/compaction of new snow
* Snow.Index: Composite snow stability index
* Insolation: Solar radiation/sun exposure. Sun warming affects snow stability
* Crystals: Crystal type/structure in snowpack
* Wetness: Moisture content of snow
* AV.Cat (Avalanche Category)
* Snow.Temp (Snow Temperature). Plausible Range: -20°C to 0°C



```{r}
data <- read.csv("~/University/MSc Data Science/STA5073Z_DS Industry/DS-Industry/scotland_avalanche_forecasts_2009_2025.csv", header = TRUE)
```

```{r, eval=FALSE}
head(data)
dim(data)
str(data)
table(data$FAH) # target variable levels
summary(data)
```


# Cleaning

```{r}
# Only keep rows where the target variable FAH is not missing (-109 rows)
data <- data %>% filter(!is.na(FAH) & FAH != "")

# Convert categorical target variable to numeric 
data$FAH <- as.integer(factor(x = data$FAH, levels = c("Low", "Moderate", "Considerable -", "Considerable +", "High"))) - 1
data$Precip.Code <- as.integer(factor(data$Precip.Code)) - 1
data$Area <- as.integer(factor(data$Area)) - 1   # 6 areas

# Create a year variable for date & Month
# Don't have any data for July, Aug and Sept (summer months) 
# Don't know if a month variable will be important? Should i make those months values be 0?
data <- data %>% mutate(Year = year(Date), Month = month(Date))
table(data$Month)

# Remove unnecessary columns
data <- data %>% select(-OSgrid, -OAH, -Obs, -Location, -longitude, -latitude, -Date)

```

# Missing data summary

```{r}
missing_summary <- data %>%
  summarise_all(~sum(is.na(.))) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "Missing_Count") %>%
  mutate(Missing_Percent = round(Missing_Count / nrow(data) * 100, 1)) %>%
  arrange(desc(Missing_Count))
missing_summary

```


* The highest mountain in Scotland is Ben Nevis, which has an altitude of 1,345 meters above sea level. Our data has to impossible outliers (77044 & 244859) = remove!

* "It is worthy of note that the highest wind speed recorded at the summit weather station on Cairngorm at the time of writing was an eye-watering 176 mph!" (78.7 m/s) https://www.mountaineering.scot/safety-and-skills/essential-skills/weather-conditions/wind-speeds

* In March 1986, on the summit of the Cairngorms in the Highlands of Scotland, a wind gust of 173mph (278km/h) was recorded.: https://www.bbc.com/weather/articles/cvglvnyxpx0o


```{r}
# Cleaning dataset from errors 
data_cleaned <- data %>%
  mutate(
    # Altitude (0 to 1345): removing Alt values 77044 and 244859	
    Alt = ifelse(Alt < 0 | Alt > 1345, NA_real_, Alt),
    
    # Aspect (0 to 360)
    Aspect = ifelse(Aspect < 0 | Aspect > 360, NA_real_, Aspect),
    
    # Incline (0 to 90)
    Incline = ifelse(Incline < 0 | Incline > 90, NA_real_, Incline),
    
    # Wind Speed - look above to reference of highest wind speed in Scotland
    Wind.Speed = ifelse(Wind.Speed < 0 | Wind.Speed > 79, NA_real_, Wind.Speed),
    
    # Cloud Cover (0 to 100) (there is just 3 wierd values: -1, -1, 199)
    Cloud = ifelse(Cloud < 0 | Cloud > 100, NA_real_, Cloud),
    
    # Clean Total Snow Depth (0 to 1500). Removing values: 2000, 2000, 2500, 3000, 2010, 2080
    Total.Snow.Depth = ifelse(Total.Snow.Depth < 0 | Total.Snow.Depth > 1500, NA_real_, Total.Snow.Depth),
    
    # Summit Wind Speed (m/s) (same threshold as Wind Speed): removed quite a few values
    Summit.Wind.Speed = ifelse(Summit.Wind.Speed < 0 | Summit.Wind.Speed > 79, NA_real_, Summit.Wind.Speed),
    
    # Foot Penetration (depth in cm) - THIS NEEDS SOME RESEARCH
    Foot.Pen = ifelse(Foot.Pen < 0 | Foot.Pen > 200, NA_real_, Foot.Pen),
    
    # Wind direction
    Wind.Dir = ifelse(Wind.Dir < 0 | Wind.Dir > 360, NA_real_, Wind.Dir),
    
    # Summit wind direction. Removed: 370, 385, 390, 2213
    # 2213 is obviously wrong but maybe 370 means 10, 385 means 25 and 390 means 30????
    
    Summit.Wind.Dir = ifelse(Summit.Wind.Dir > 360 & Summit.Wind.Dir <= 720, 
                              Summit.Wind.Dir - 360, Summit.Wind.Dir), # Should i add this line in???
    
    Summit.Wind.Dir = ifelse(Summit.Wind.Dir < 0 | Summit.Wind.Dir > 360, NA_real_, Summit.Wind.Dir),
    
    # New Snow Settlement (cant be negative values). There are three large outliers (> 600). 
    # Measured in cm
    # If this is measured in cm values > 100 are intense! Highly unusual
    # Could someone please check this? Something is wrong here
    No.Settle = ifelse(No.Settle < 0, NA_real_, No.Settle),
    
    # Insolation
    # Assuming it is Daily Solar Radiation (MJ/m²/day): remove values > 30 (outlier values 106 & 208 removed)
    Insolation = ifelse(Insolation < 0 | Insolation > 30, NA_real_, Insolation))

```


Aspect & wind direction are circular variables, where 0° and 360° represent the same direction - these variables MUST be converted into two features using sine and cosine transformations

```{r}
data_cleaned <- data_cleaned %>% 
  mutate(Aspect_sin = sin(Aspect * pi / 180), Aspect_cos = cos(Aspect * pi / 180)) %>% 
  mutate(WindDir_sin = sin(Wind.Dir * pi / 180), WindDir_cos = cos(Wind.Dir * pi / 180)) %>%
  mutate(SummitWindDir_sin = sin(Summit.Wind.Dir * pi / 180), SummitWindDir_cos = cos(Summit.Wind.Dir * pi / 180)) %>%
  select(-Wind.Dir, -Aspect, -Summit.Wind.Dir)

```


# Wierd variables that dont make enough sense:

### Investigating Ski Pen variable

* Ski.Pen: 7485 rows of values 0. 2375 rows of NA values.
* The thing is, you'd expect large foot.pen values to correspond with sk.pin values greater than 0, but I'm not seeing that? Ski.pen seems very sus.
* Ski.pen = 0 for very large values of foot.pen...Cant be right
* It doesn't seem worth keeping this variable in the analysis???

```{r}
nrow(data[data$Ski.Pen == 0 & !is.na(data$Ski.Pen), ])
data[data$Ski.Pen == 0 & data$Foot.Pen > 50 & !is.na(data$Ski.Pen) & !is.na(data$Foot.Pen), ]

# Removing rows with NA in Ski.Pen or Foot.Pen
clean_data <- data[!is.na(data$Ski.Pen) & !is.na(data$Foot.Pen), ]

plot(clean_data$Ski.Pen, clean_data$Foot.Pen, xlab = "Ski Penetration", 
     ylab = "Foot Penetration",pch = 19)
```


### Investigating Max.Temp.Grad

* 4635 rows of values = 0
* 642 NA.
* Must do more research here

```{r}
summary(data$Max.Temp.Grad)


data[data$Max.Temp.Grad > 40 & !is.na(data$Max.Temp.Grad), ]

nrow(data[data$Max.Temp.Grad == 0 & !is.na(data$Max.Temp.Grad), ])

summary(data$Max.Temp.Grad, na.rm = TRUE)
na.omit(data$Max.Temp.Grad)
```

### Investigating Crystals & Wetness

* How to deal with these variables?
* -1 must mean no result/na?
* The categories aren't making sense

```{r}
table(data$Crystals)
# -1: Missing ???
# 0: Very fine grains, fresh snow, or rounded grains (<0.5mm)??
# 1: Small grains (1mm)
# 2: Medium grains (2mm)
# 5: Large grains (5mm) 
# 8: Very large grains
# 10: Extreme grain size 
# 11 & 15: Exceptionally large crystals 

table(data$Crystals, data$FAH)

table(data$Wetness) # -1, 0, 1, 2,3, 4, 6, 10 ????
table(data$Wetness, data$FAH)
```

### Investigating AV.Cat (likely stands for avalanche category)

This just seems sus... This should be left out of analysis

```{r}
table(data$AV.Cat, useNA = "ifany")

summary(data$AV.Cat)

unique(data$AV.Cat)

# Check relationship with FAH
table(data$AV.Cat, data$FAH)

# Missing Vlaues
sum(is.na(data$AV.Cat) | data$AV.Cat == "NA" | data$AV.Cat == -1)
```

### Investigating Snow.Temp

Something is very wrong here. Snow melts > 0 degrees Celsius. What to do about this?
0 to 0.5 degrees celcius is a plausable range for melthing snow.

```{r}
# What temp values are > 0 degrees celcius - 246 rows!!!
data[data$Snow.Temp > 0.5 & !is.na(data$Snow.Temp), ]

summary(data$Snow.Temp, na.rm = TRUE)
na.omit(data$Snow.Temp)

# Checking the distribution of these errors
summary(data$Snow.Temp[data$Snow.Temp > 0 & !is.na(data$Snow.Temp)])

# Are they clustered around certain values?
table(data$Snow.Temp[data$Snow.Temp > 0 & !is.na(data$Snow.Temp)])

# These rows compared to Air.Temp...Somethings very wrong
data %>%
  filter(Snow.Temp > 0.5) %>%
  select(Month, Snow.Temp, Air.Temp) 
```


### Investigating Insolation (solar radiation)

What is going on here. Struggling to make sense of this variable.

```{r}
table(data$Insolation, data$FAH)

```


### Investigating No.Settle

I feel like the very large values can't be correct

```{r}
summary(data$No.Settle)

data[data$No.Settle < 5 & !is.na(data$No.Settle), ]

plot(data$No.Settle, data$Total.Snow.Depth)

data %>% select(Foot.Pen, No.Settle, Total.Snow.Depth) %>% na.omit()

```


### Investigating Snow.Index

Don't quite know how to interpret Snow.Index. 737 missing. 7677 zero values.

```{r}
table(data$Snow.Index)
summary(data$Snow.Index)
```











# Important notes

### Variables that CANNOT be used - EXCLUDE:

1. Ski.Pen - 2,404 out of 10,671 records (22.5%) missing - too much missing data for reliable neural network training
2. AV.Cat - 2,494 records (23.4%) missing & manyyy values that are DEFINITLY errors


### Variables that don't seem to be necessary:

1. Locations (we already have Area to work with)
....


# Boxplots of numeric variables

Before above data cleaning

```{r}
numeric_variables <- data %>% 
  select(Alt, Incline, Air.Temp, Wind.Speed, Total.Snow.Depth, Foot.Pen, Ski.Pen,
         Summit.Air.Temp, Summit.Wind.Speed, No.Settle, Insolation, Snow.Temp, 
         Aspect, Wind.Dir, Summit.Wind.Dir, Max.Temp.Grad, Max.Hardness.Grad)


plot_group_boxplots <- function(vars, df) {
  plots <- lapply(vars, function(v) {
    ggplot(df, aes(y = .data[[v]])) +
      geom_boxplot() +
      labs(title = v, y = v) +
      theme_minimal()
  })
  do.call(grid.arrange, c(plots, ncol = 3))
}

# Terrain-related variables
plot_group_boxplots(c("Alt", "Incline", "Aspect"), numeric_variables)

# Weather variables
plot_group_boxplots(c("Air.Temp", "Wind.Speed", "Summit.Air.Temp"), numeric_variables)

# Snowpack variables
plot_group_boxplots(
  c("Total.Snow.Depth", "Foot.Pen", "No.Settle", "Max.Temp.Grad", "Max.Hardness.Grad"), 
  numeric_variables)

# Snow temperature & radiation
plot_group_boxplots(c("Snow.Temp", "Insolation"), numeric_variables)

# Wind direction components
plot_group_boxplots(c("Wind.Dir", "Summit.Wind.Dir"), numeric_variables)

# Ski penetration variable (optional separate plot)
plot_group_boxplots(c("Ski.Pen"), numeric_variables)
```

After above data cleaning

```{r}
numeric_variables <- data_cleaned %>% 
  select(Alt, Incline, Air.Temp, Wind.Speed, Total.Snow.Depth, Foot.Pen, Ski.Pen,
         Summit.Air.Temp, Summit.Wind.Speed, No.Settle, Insolation, Snow.Temp, 
         Aspect_sin, Aspect_cos, WindDir_sin, WindDir_cos, SummitWindDir_sin,
         SummitWindDir_cos, Max.Temp.Grad, Max.Hardness.Grad)

# Terrain-related variables
plot_group_boxplots(c("Alt", "Incline", "Aspect_sin"), numeric_variables)

# Weather variables
plot_group_boxplots(c("Air.Temp", "Wind.Speed", "Summit.Air.Temp"), 
  numeric_variables)

# Snowpack variables
plot_group_boxplots(
  c("Total.Snow.Depth", "Foot.Pen", "No.Settle", "Max.Temp.Grad", "Max.Hardness.Grad"), 
  numeric_variables)

# Snow temperature & radiation
plot_group_boxplots(c("Snow.Temp", "Insolation"), numeric_variables)

# Wind direction components
plot_group_boxplots(
  c("WindDir_sin", "WindDir_cos", "SummitWindDir_sin", "SummitWindDir_cos"), 
  numeric_variables)

# Ski penetration variable (optional separate plot)
plot_group_boxplots(c("Ski.Pen"), numeric_variables)

```





# Correlation Analysis

```{r}
numeric_vars <- data_cleaned %>% 
  select(Alt, Incline, Air.Temp, Wind.Speed, Total.Snow.Depth, Foot.Pen,
         Summit.Air.Temp, Summit.Wind.Speed, No.Settle, Insolation, Snow.Temp, 
         Aspect_sin, Aspect_cos, WindDir_sin, WindDir_cos, SummitWindDir_sin,
         SummitWindDir_cos)

cor_matrix <- cor(numeric_vars, use = "complete.obs")

corrplot(cor_matrix, 
         method = "color",
         type = "upper",
         order = "hclust",
         tl.cex = 0.7,        
         tl.col = "black",     
         tl.srt = 45, 
         title = "Correlation Matrix - Scottish Avalanche Data",
         mar = c(0,0,2,0))

```




