---
title: "EDA"
author: "Saadia Abdullah"
date: "2025-09-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Explanatory Data Analysis

### Load Libraries

```{r libraries}

library(tidyverse)
library(corrplot)
library(VIM)
library(gridExtra)
library(lubridate)
library(mice)
library(caret)

```

### Load Data

```{r data}

set.seed(12345)

data <- read.csv('/Users/saadiaabdullah/Desktop/UCT/2025/Data Science For Industry/EDA Assignment 1/scotland_avalanche_forecasts_2009_2025 (1).csv')

dim(data)
print(summary(data))

data$Date <- as.Date(data$Date) # date as date type

data$FAH[data$FAH == ""] <- NA

# Create ordinal encoding
data$FAH_numeric <- case_when(
  data$FAH == "Low" ~ 1,
  data$FAH == "Moderate" ~ 2,
  data$FAH == "Considerable -" ~ 3,
  data$FAH == "Considerable +" ~ 4,
  data$FAH == "High" ~ 5,
  TRUE ~ NA_real_
)

data$FAH <- factor(data$FAH, 
                   levels = c("Low", "Moderate", "Considerable -", 
                             "Considerable +", "High"),
                   ordered = TRUE)

```

### FAH Distribution

```{r FAH}

ggplot(data, aes(x = factor(FAH))) +
  geom_bar(fill = "darkblue") +
  labs(title = "Distribution of Forecasted Avalanche Hazard (FAH)",
       x = "FAH", y = "Count") +
  theme_minimal() 

ggplot(data , aes(x = factor(FAH), fill = Area)) +
  geom_bar(position = "dodge") +
  labs(title = "FAH Distribution by Area",
       x = "FAH", y = "Count") +
  theme_minimal() +
  theme(legend.position = "bottom")

```

### Missing data and Imputation

```{r imputation}

missing_data <- data %>%
  summarise_all(~sum(is.na(.))) %>%
  gather(key = "Variable", value = "Missing_Count") %>%
  mutate(Missing_Perc = round((Missing_Count / nrow(data)) * 100, 2)) %>%
  arrange(desc(Missing_Perc))

print(missing_data)

# Imputation

# No variables have more than 50% missing data so impute all missing values.

pred_1 <- c("longitude", "latitude", "Alt", "Aspect", "Incline")

pred_2 <- c("Air.Temp", "Wind.Dir", "Wind.Speed", "Cloud", "Drift",
                     "Summit.Air.Temp", "Summit.Wind.Dir", "Summit.Wind.Speed")

pred_3 <- c("Max.Temp.Grad", "Max.Hardness.Grad", "No.Settle", 
                     "Snow.Index", "Insolation", "Crystals", "Wetness", "Snow.Temp")

all_pred <- c(pred_1, pred_2, pred_3)

# Missing data plot

md.pattern(data[,c("FAH_numeric", all_pred[1:min(10, length(all_pred))])], rotate.names = TRUE) 

mice_data <- data %>%
  select(FAH_numeric, all_of(all_pred))

set.seed(12345)

mice_output <- mice(mice_data, m = 5, method = 'pmm', printFlag = FALSE)

data_imputed <- complete(mice_output, 1)

# Diagnostic Plots
# Strip plot - shows distribution of imputed values

stripplot(mice_output, pch=20, cex=1.2)

densityplot(mice_output, ~ Alt)
densityplot(mice_output, ~ Aspect)
densityplot(mice_output, ~ Incline)

densityplot(mice_output, ~ Air.Temp) # bad
densityplot(mice_output, ~ Wind.Dir)
densityplot(mice_output, ~ Wind.Speed)
densityplot(mice_output, ~ Cloud) # bad

densityplot(mice_output, ~ Summit.Air.Temp)
densityplot(mice_output, ~ Summit.Wind.Dir)
densityplot(mice_output, ~ Summit.Wind.Speed)

densityplot(mice_output, ~ Max.Temp.Grad)
densityplot(mice_output, ~ Max.Hardness.Grad) # bad
densityplot(mice_output, ~ No.Settle)
densityplot(mice_output, ~ Snow.Index)
densityplot(mice_output, ~ Insolation)
densityplot(mice_output, ~ Crystals) # bad
densityplot(mice_output, ~ Wetness) # bad
densityplot(mice_output, ~ Snow.Temp) # bad

# Convergence plot

plot(mice_output, main = "MICE Convergence - All Variables")

bad_vars <- c("Air.Temp", "Cloud", "Max.Hardness.Grad", 
              "Crystals", "Wetness", "Snow.Temp")

mice_data <- mice_data %>%
  select(FAH_numeric, all_of(setdiff(all_pred, bad_vars)))

dim(mice_data)

set.seed(12345)

mice_output2 <- mice(mice_data, m = 5, method = 'pmm', printFlag = FALSE)
data_imputed2 <- complete(mice_output2, 1)

```

### Outlier Detection

```{r outliers}

cont_vars <- c("longitude", "latitude", "Alt", "Aspect", "Incline",
                     "Wind.Dir", "Wind.Speed", "Summit.Air.Temp", 
                     "Summit.Wind.Dir", "Summit.Wind.Speed",
                     "Max.Temp.Grad", "No.Settle", "Snow.Index", "Insolation")

cont_vars <- cont_vars[cont_vars %in% names(data_imputed2)]

# Handle outliers by capping them

for(var in cont_vars) {
  if(var %in% names(data_imputed2) && is.numeric(data_imputed2[[var]])) {
    
    x <- data_imputed2[[var]]
    
    lower_bound <- quantile(x, 0.01, na.rm = TRUE)
    upper_bound <- quantile(x, 0.99, na.rm = TRUE)
    
    n_outliers <- sum(x < lower_bound | x > upper_bound, na.rm = TRUE)
    data_imputed2[[var]][x < lower_bound] <- lower_bound
    data_imputed2[[var]][x > upper_bound] <- upper_bound
  
  }
}

```


### Correlation Analysis

```{r corr}

# Use imputed data (no missing values)

corr_data <- data_imputed2  

corr_matrix <- cor(corr_data, use = "complete.obs")

# Correlation with FAH
fah_corr <- corr_matrix[,"FAH_numeric"] %>%
  as.data.frame() %>%
  rownames_to_column("Variable") %>%
  rename(Correlation = ".") %>%
  filter(Variable != "FAH_numeric") %>%
  arrange(desc(abs(Correlation)))

# Top 10 correlations with FAH
print(head(fah_corr, 10))

# Correlation heatmap
corrplot(corr_matrix, method = "color", type = "upper", 
         order = "hclust", tl.cex = 0.7, tl.col = "black")

# FAH Correlation

data_imputed2$FAH <- factor(data_imputed2$FAH_numeric,
                           levels = 1:5,
                           labels = c("Low", "Moderate", "Considerable -", 
                                     "Considerable +", "High"))

# Predictor 1

predictor_1 <- pred_1[pred_1 %in% names(data_imputed2)]

data1 <- data_imputed2 %>%
  select(FAH, FAH_numeric, all_of(predictor_1))

corr1 <- cor(data1[,predictor_1], data1$FAH_numeric) %>%
  as.data.frame() %>%
  rownames_to_column("Variable") %>%
  rename(FAH_Correlation = "V1") %>%
  arrange(desc(abs(FAH_Correlation)))

# Create boxplots
plot1 <- list()
for(i in 1:min(4, length(predictor_1))) {
  var <- predictor_1[i]
  plot1[[i]] <- ggplot(data1, aes(x = factor(FAH), y = .data[[var]])) +
    geom_boxplot(fill = "darkblue", alpha = 0.7) +
    labs(title = paste(var, "vs FAH"),
         x = "FAH", y = var) +
    theme_minimal()
}

do.call(grid.arrange, c(plot1, ncol = 2))

# Predictor 2

predictor_2 <- pred_2[pred_2 %in% names(data_imputed2)]

data2 <- data_imputed2 %>%
  select(FAH, FAH_numeric, all_of(predictor_2))

corr2 <- cor(data2[,predictor_2], data2$FAH_numeric) %>%
  as.data.frame() %>%
  rownames_to_column("Variable") %>%
  rename(FAH_Correlation = "V1") %>%
  arrange(desc(abs(FAH_Correlation)))

plot2 <- list()
for(i in 1:min(4, length(predictor_2))) {
  var <- predictor_2[i]
  plot2[[i]] <- ggplot(data2, aes(x = factor(FAH), y = .data[[var]])) +
    geom_boxplot(fill = "darkgreen", alpha = 0.7) +
    labs(title = paste(var, "vs FAH"),
         x = "FAH", y = var) +
    theme_minimal()
}

do.call(grid.arrange, c(plot2, ncol = 2))

# Predictor 3

predictor_3 <- pred_3[pred_3 %in% names(data_imputed2)]

data3 <- data_imputed2 %>%
  select(FAH, FAH_numeric, all_of(predictor_3))

corr3 <- cor(data3[,predictor_3], data3$FAH_numeric) %>%
  as.data.frame() %>%
  rownames_to_column("Variable") %>%
  rename(FAH_Correlation = "V1") %>%
  arrange(desc(abs(FAH_Correlation)))

plot3 <- list()
for(i in 1:min(4, length(predictor_3))) {
  var <- predictor_3[i]
  plot3[[i]] <- ggplot(data3, aes(x = factor(FAH), y = .data[[var]])) +
    geom_boxplot(fill = "darkred", alpha = 0.7) +
    labs(title = paste(var, "vs FAH"),
         x = "FAH", y = var) +
    theme_minimal()
}

do.call(grid.arrange, c(plot3, ncol = 2))

```

```{r scale data}

set.seed(12345)

train_index <- createDataPartition(data_imputed2$FAH_numeric, 
                                   p = 0.7, 
                                   list = FALSE)
train_data <- data_imputed2[train_index, ]
test_data <- data_imputed2[-train_index, ]

# Standardisation

preproc_obj <- preProcess(
  train_data %>% select(all_of(cont_vars)),
  method = c("center", "scale")  
)

train_scaled <- predict(preproc_obj, train_data)
test_scaled <- predict(preproc_obj, test_data)

```
